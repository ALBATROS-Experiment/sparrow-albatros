<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Note on FFT Implementation - Sparrow Albatros</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Note on FFT Implementation";
        var mkdocs_page_input_path = "fft-note.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Sparrow Albatros
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Embedded Software</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../data-collection/">Run the DAQ, collect data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuning-the-gateware/">Tuning the gateware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../digital-gain-coefficients-4bit/">Optimal Digital Gain Coefficients (4-bit)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dump-baseband/">Dumping baseband</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dump-spectra/">Dumping correlated spectra</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../networking/">Networking</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Gateware</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../installing-the-toolchain/">Installing the Toolchain</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-design/">Design Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Note on FFT Implementation</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#what-is-a-fast-fourier-transform-fft">What is a Fast Fourier Transform (FFT)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#radix-2-decomposition">Radix-2 Decomposition</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pipelining">Pipelining</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#biplexing">Biplexing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#symmetric-group-buffering">Symmetric Group Buffering</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#fft-shift-schedule">FFT Shift Schedule</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#bit-growth">Bit Growth</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-modify-simulate/">Modify and Simulate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-compile-synthesize-implement/">Compile, Synthesize, Implement</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Disk Images</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installing-sparrow-albatros/">Installing Sparrow Albatros</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Data Specification</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../data-baseband/">Baseband</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../data-correlated-spectra/">Correlated Spectra</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Sparrow Albatros</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Gateware</li>
      <li class="breadcrumb-item active">Note on FFT Implementation</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="a-note-on-caspers-fft-implementation">A Note on CASPER's FFT Implementation</h1>
<h2 id="what-is-a-fast-fourier-transform-fft">What is a Fast Fourier Transform (FFT)</h2>
<p>The Fast Fourier Transform is an algorithm that implements the Discrete Fourier Transform (DFT). The DFT is a discrete version of the Fourier Transform, which is a linear functional over the complex plane. </p>
<p>Lets say you want to to find the frequency components of an electric field signal that fluctuates over time. To do this digitally, first you have to sample that electric field at discrete time points. Mathematicaly, that's like multiplying a continuous signal with a Dirac Comb. Take the Fourier Transform of that and apply the convolution theorem, </p>
<div class="arithmatex">\[
F\{x(t) \cdot \text{DiracComb}_{\Delta t} \} = F\{x(t) \} \ast \text{DiracComb}_{1/\Delta t}, 
\]</div>
<p>and the result is the Fourier Transform multiplied by a Dirac Comb with reciprical spacing. If the spacing between samples in the input, <span class="arithmatex">\(\Delta t\)</span>, is very small, then the spacing between output is large. Convolving with a dirac comb will alias frequencies seperated by integer multiples of <span class="arithmatex">\(1/\Delta t\)</span> together, so to get around that, make sure that your signal <span class="arithmatex">\(x(t)\)</span> only has frequency information between <span class="arithmatex">\(-1 \over 2\Delta t\)</span> and <span class="arithmatex">\(1 \over 2\Delta t\)</span>. This region is known as the first Nyquist zone. </p>
<p>The result is a repeting finite but continuous patch of frequency space. Sample that at <span class="arithmatex">\(N\)</span> linear-spaced points and you have a Discrete Fourier Transform (DFT). More commonly, the DFT is written as the linear transformation, </p>
<div class="arithmatex">\[
\hat x[k] = \sum_{t=0}^{N-1} e^{-2\pi i kt/N}x[t],
\]</div>
<p>or, in matrix notation, </p>
<div class="arithmatex">\[
\begin{bmatrix}
1 &amp; 1 &amp; 1 &amp; ...&amp; 1\\
1 &amp; e^{-2\pi i \over N} &amp; e^{-4\pi i \over N} &amp; ... &amp; e^{-(N-1)2\pi i \over N} \\
1 &amp; e^{-4\pi i \over N} &amp; e^{-8\pi i \over N} &amp; ... &amp; e^{-(N-1)4\pi i \over N} \\
\vdots &amp; \vdots &amp; \vdots &amp; \ddots &amp; \vdots 
\end{bmatrix}.
\]</div>
<p>This matrix is fully packed and not sparse, so you might assume that it would take <span class="arithmatex">\(O(N^2)\)</span> multiply operations to execute it on a computer. As it happens, Cooley and Tukey (1963 [citation needed]) figured out a way to do it in <span class="arithmatex">\(O(N log N)\)</span> multiplications. Their algorithm is known as the Fast Fourier Transform (FFT). Understanding the FFT amounts to understanding a single matrix decomposition called Radix-2 Decomposition. </p>
<h2 id="radix-2-decomposition">Radix-2 Decomposition</h2>
<p>Start with the definition of your DFT, </p>
<div class="arithmatex">\[
\hat x[k] = \sum_{t=0}^{N-1} e^{-2\pi i kt/N}x[t],
\]</div>
<p>and assume, for simplicity, that <span class="arithmatex">\(N\)</span> is a power of 2. Notice that you can split the sum half way like so, </p>
<div class="arithmatex">\[
\hat x[k] = \sum_{t=0,2,4,...}^{N-2} e^{-2\pi i kt \over N}x[t] + \sum_{t=1,3,5,...}^{N-1} e^{-2\pi i kt \over N}x[t].
\]</div>
<p>Then re-index those two sums and, for the latter sum, pop out a "twiddle" factor, like so, </p>
<div class="arithmatex">\[
\hat x[k] = \sum_{t=0}^{(N/2)-1} e^{-2\pi i kt \over N/2}x[2t] + e^{-2\pi ik/N}\sum_{t=0}^{(N/2)-1} e^{-2\pi i kt \over N/2}x[2t+1].
\]</div>
<p>Notice that we've just turned one DFT into two smaller DFTs. The first thing we did was change </p>
<h2 id="pipelining">Pipelining</h2>
<ul>
<li>explain how FFTs are usually optimized</li>
</ul>
<h2 id="biplexing">Biplexing</h2>
<ul>
<li>xyz</li>
</ul>
<h2 id="symmetric-group-buffering">Symmetric Group Buffering</h2>
<ul>
<li>xyz cite Aaron Parson's symetric group paper and optimization</li>
</ul>
<h2 id="fft-shift-schedule">FFT Shift Schedule</h2>
<ul>
<li>What is the shift schedule. Link to how to program it in other document. </li>
<li>What is the trade off in terms of resources etc.</li>
</ul>
<p>The FFT is implemented in log2 N (=12, in our case) "butterfly" stages. At each stage there's a risk of integer overflow. Shifting by one bit (or dividing the signal by two) at some or all stages mitigates that risk at the cost of losing the least significant bit's worth of information. </p>
<p>To see where the risk of overflow comes from, look at the DFT formula, </p>
<div class="arithmatex">\[
\hat x[k] = \sum_{t=0}^{N-1} x[t] e^{-2pi i kt\over N},
\]</div>
<p>which has the property</p>
<div class="arithmatex">\[
\sum_k |\hat x[k]|^2 = N \sum_t |x[t]|^2.
\]</div>
<p>That is to say that the power of the FT is N times the power of the original signal. At each butterfly stage the magnitude of the intermediate signal product grows by the square root of two on expectation, and it grows by a factor of two at most. In the extreme case where the input in sinusoidal and the output is a dirac function, in each butterfly stage, at least one intermediate product will grow by a factor of two in each stage, requiring a full shift schedule to avoid overflow. Human made RFI are typically strong and narrow band in frequency space, that is why we care so much about out-of-band rejection. Regarding the FFT, the narrow-band nature of RFI means we expect some of our frequency bands to grow by a large factor on each butterfly (close to a factor of two) which means, in turn, that our science bands won't have as much room to grow, and may even shrink. </p>
<p>We have found from experiance in the field that the sky's power spectrum causes FFT overflows if we do not shift aggressively. Until now we have opted to shift aggressively at the expense of raising the noise floor. Every time we shift we lose, on average, half of a least significant bit of range. However, the signals of interest to us are in the quiet channels and are even more sensitive to bit shifting. We may lose up to one bit of resolution with each shift.  </p>
<h2 id="bit-growth">Bit Growth</h2>
<p>Instead of shifting aggressively, we can grow the capacity of each integery by one bit on each butterfly stage, this way we can enjoy the benefits of shifting without worrying about overflow. We compare on-board accumulated spectra with and without bit-growth. </p>
<p><em>Below, spectra from full shift schedule FFT, 18 bits input (12 bits ADC + 6 bits LSB-padding). Input signal is a 61.03515625 kHz square wave. The Fourier Series coefficients of a square wave go like 1/n. Pol1 had a longer cable than Pol0. The longer cable acts like a better antenna, which is why Pol1 is picking up more signal between 50 and 125 MHz.</em></p>
<p><img alt="Screenshot from 2025-04-28 14-09-27" src="https://github.com/user-attachments/assets/508c1d11-d422-4381-b4c8-77f1f34367db" /></p>
<p><em>Below, same as above but with bit-growth FFT. Starts at 18 btis (12 bits ADC + 6 bits LSB-padding), grows by one bit in first six butterfly stages, then bit shifts on the remaining six stages. The resulting signal is 24 bits deep.</em></p>
<p><img alt="Screenshot from 2025-04-28 14-26-50" src="https://github.com/user-attachments/assets/9156354d-e989-4790-8edc-771f7c1f0028" /></p>
<p><em>Below, spectra full shift, as above. No signal input from the function generator.</em></p>
<p><img alt="Screenshot from 2025-04-28 14-37-49" src="https://github.com/user-attachments/assets/c4faf5b3-9aee-4393-8e11-390f8ecd4050" /></p>
<p><em>Below, bit-growth FFT, as above. No signal input from func-gen.</em></p>
<p><img alt="Screenshot from 2025-04-28 14-33-05" src="https://github.com/user-attachments/assets/9a5a274f-2a06-4e04-aae8-8a04ccdfb364" /></p>
<p>In summary, the bit growth FFT... </p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../gateware-design/" class="btn btn-neutral float-left" title="Design Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../gateware-modify-simulate/" class="btn btn-neutral float-right" title="Modify and Simulate">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../gateware-design/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../gateware-modify-simulate/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../wavedrom-init.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
