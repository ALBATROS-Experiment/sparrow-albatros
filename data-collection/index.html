<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Run the DAQ, collect data - Sparrow Albatros</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../stylesheets/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Run the DAQ, collect data";
        var mkdocs_page_input_path = "data-collection.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Sparrow Albatros
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Embedded Software</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Run the DAQ, collect data</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick start</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#checking-and-troubleshooting">Checking and troubleshooting</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#in-depth">In Depth</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tuning-the-gateware/">Tuning the gateware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../digital-gain-coefficients-4bit/">Optimal Digital Gain Coefficients (4-bit)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Gateware</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installing-the-toolchain/">Installing the Toolchain</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-design/">Design Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-modify-simulate/">Modify and Simulate</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gateware-compile-synthesize-implement/">Compile, Synthesize, Implement</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Disk Images</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../installing-sparrow-albatros/">Installing Sparrow Albatros</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Sparrow Albatros</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Embedded Software</li>
      <li class="breadcrumb-item active">Run the DAQ, collect data</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="collecting-data">Collecting data</h1>
<h2 id="quick-start">Quick start</h2>
<ol>
<li><strong>Power and boot</strong> the Sparrow system box, connect the ethernet port to your laptop with an ethernet cable (RJ45 connector, you'll need an ethernet port or dongle for your laptop)</li>
<li><strong>SSH</strong> into the Ubuntu OS running on the Sparrow's ARM core with <code>ssh casper@10.10.11.99</code>, enter the password, "casper", when prompted. The Sparrow's ARM is configured to statically assign it's Eth0 interface to the <code>10.10.11.99</code> ipv4 address. If you have trouble with the next two step you may need to configure you're laptop's wired ethernet interface manually to be on the 10.10.xx.xx subnet (subnet mask 255.255.0.0, with an IP address e.g. 10.10.11.55)</li>
<li><strong>Mount a hard drive</strong> connected over usbA port to this mountpoint: <code>/media/BASEBAND</code> with this command <code>sudo mount /dev/&lt;your HD partition e.g. sda2&gt; /media/BASEBAND</code>. Then run <code>lsblk</code> to identify connected hard drives (Sparrow only supports ext4 formated hard drives). Make sure that the HDD's mounted partition has a <code>/baseband</code> directory.</li>
<li>Enter the data acquisition directory using the aliased shortcut <code>daq</code> (you should now have cd'd into <code>/home/casper/sparrow-albatros/software</code>).</li>
<li>Edit the <code>config.ini</code> configuration file to suit your needs.</li>
<li>Run the DAQ in sudo by executing <code>sudo ./rundaq.sh</code>.</li>
</ol>
<p>That's it! </p>
<h2 id="checking-and-troubleshooting">Checking and troubleshooting</h2>
<ul>
<li>Verify that baseband is writing to <code>/media/BASEBAND/baseband</code>, that on-board-correlated data is writing to <code>/home/casper/data_auto_cross</code>, and that logs are writing to <code>/home/casper/logs</code>. </li>
<li>If baseband is not writing, open up Wireshark on your laptop and snoop on your wired connection in promiscuous mode. If baseband is dumping correctly you'll be met with a deluge of UDP packets. Look at one of those UDP packets and make sure the UDP payload is not all zeros. You should be weary if there are too many zeros, the data is almost incompressible (i.e. very high entropy).  </li>
<li>To verify the integrity of your signal, use -X port forwarding and run <code>python livespec.py 0 125</code> (in the <code>daq</code> directory). </li>
</ul>
<h2 id="in-depth">In Depth</h2>
<p>If you're going to modify the code it's good to know how it all sticks together. </p>
<hr />
<p>TODO: everything below here needs to be deleted/adapted to explain what rundaq.sh does instead</p>
<p>Now that you've tunneled in, you can run data collection. </p>
<ol>
<li>Find out the name of the drive connected with <code>lsblk</code>, it will probably be <code>sda1</code></li>
<li>Mount the drive <code>sudo mount /dev/sda1 /media/BASEBAND</code></li>
<li>Navigate to the software directory <code>cd ~/sparrow-albatros/software</code></li>
<li>Modify the user configuration file <code>config.ini</code> to fit your needs</li>
<li>Configure the FPGA with <code>python configfpga.py</code> and make sure the switch's lights are flashing consistently. </li>
<li>Start a screen session for recording the on board correlations <code>screen -S spec</code></li>
<li>From this screen session run <code>python dump_spectra.py</code>. You may need to run this in sudo in which case make sure to run the correct python interpreter. Find the one activated in the current VM with <code>which python</code>, then copy the result of this and run <code>sudo &lt;/path/to/python/interpreter&gt; dump_spectra.py</code></li>
<li>Detach yourself from the screen session with <code>ctrl</code>+<code>a</code>+<code>d</code> </li>
<li>Start a new screen session for running the baseband collection script <code>screen -S baseband</code></li>
<li>If you are collecting 4-bit data run <code>python set_optimal_coeffs.py</code>, this uses the on board correlation to optimally set the digital gain coefficients at the requantization stage. [!NOTE] This can only be run at least 15 seconds after the FPGA has been configured (step 5)</li>
<li>Compile the c-code that reads UDP packets and writes them to disk with <code>make clean;make</code></li>
<li>Run the c-code with superuser privilages <code>sudo ./dump_baseband</code></li>
<li>Detach yourself from the screen session <code>ctrl</code>+<code>a</code>+<code>d</code></li>
<li>Check that on-board correlations are being written to <code>~/data_auto_cross</code> and that baseband is being written to <code>/media/BASEBAND/baseband</code>. An easy way to do this is to <code>ls -lh</code> multiple times and watch files grow. Make sure the baseband is sensible (not all zeros or railed) by sniffing the packets and looking at hexdumps of the payloads with Wireshark. </li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tuning-the-gateware/" class="btn btn-neutral float-right" title="Tuning the gateware">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tuning-the-gateware/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../wavedrom-init.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
